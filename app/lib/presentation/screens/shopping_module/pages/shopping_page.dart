import 'package:flutter/material.dart';

import 'package:inbota/modules/shopping/data/models/shopping_item_output.dart';
import 'package:inbota/modules/shopping/data/models/shopping_list_output.dart';
import 'package:inbota/presentation/screens/shopping_module/components/create_shopping_item_bottom_sheet.dart';
import 'package:inbota/presentation/screens/shopping_module/components/create_shopping_list_bottom_sheet.dart';
import 'package:inbota/presentation/screens/shopping_module/controller/shopping_controller.dart';
import 'package:inbota/shared/components/ib_lib/index.dart';
import 'package:inbota/shared/state/ib_state.dart';
import 'package:inbota/shared/theme/app_colors.dart';

class ShoppingPage extends StatefulWidget {
  const ShoppingPage({super.key});

  @override
  State<ShoppingPage> createState() => _ShoppingPageState();
}

class _ShoppingPageState extends IBState<ShoppingPage, ShoppingController> {
  @override
  void initState() {
    super.initState();
    controller.load();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: Listenable.merge([
        controller.loading,
        controller.error,
        controller.visibleShoppingLists,
        controller.itemsByList,
      ]),
      builder: (context, _) {
        final loading = controller.loading.value;
        final error = controller.error.value;
        final shoppingLists = controller.visibleShoppingLists.value;
        final itemsByList = controller.itemsByList.value;

        final showFullLoading = loading && shoppingLists.isEmpty;

        return Stack(
          children: [
            ColoredBox(
              color: AppColors.background,
              child: ListView(
                padding: const EdgeInsets.fromLTRB(20, 20, 20, 24),
                children: [
                  _buildHeader(context),
                  if (error != null && error.isNotEmpty) ...[
                    const SizedBox(height: 12),
                    IBText(
                      error,
                      context: context,
                    ).caption.color(AppColors.danger600).build(),
                  ],
                  const SizedBox(height: 18),
                  if (shoppingLists.isEmpty)
                    const IBCard(
                      child: IBEmptyState(
                        title: 'Sem listas de compras',
                        subtitle:
                            'Quando você confirmar uma lista pelo inbox, ela aparecerá aqui.',
                        icon: IBHugeIcon.shoppingBag,
                      ),
                    )
                  else
                    ...shoppingLists.map((shoppingList) {
                      final items = itemsByList[shoppingList.id] ?? const [];
                      return Padding(
                        padding: const EdgeInsets.only(bottom: 14),
                        child: _buildShoppingListCard(
                          context,
                          shoppingList: shoppingList,
                          items: items,
                        ),
                      );
                    }),
                ],
              ),
            ),
            if (showFullLoading)
              const Positioned.fill(
                child: ColoredBox(
                  color: AppColors.background,
                  child: Center(
                    child: IBLoader(label: 'Carregando listas de compras...'),
                  ),
                ),
              ),
          ],
        );
      },
    );
  }

  Widget _buildHeader(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              IBText('Compras', context: context).titulo.build(),
              const SizedBox(height: 6),
              IBText(
                'Todas as suas listas e itens para comprar em um só lugar.',
                context: context,
              ).muted.build(),
            ],
          ),
        ),
        IconButton(
          tooltip: 'Criar lista',
          onPressed: _openCreateShoppingListSheet,
          icon: const IBIcon(
            IBIcon.addRounded,
            color: AppColors.primary700,
            size: 20,
          ),
        ),
      ],
    );
  }

  Widget _buildShoppingListCard(
    BuildContext context, {
    required ShoppingListOutput shoppingList,
    required List<ShoppingItemOutput> items,
  }) {
    final doneCount = items.where((item) => item.isDone).length;
    final pendingCount = items.length - doneCount;
    final canConclude = controller.canConcludeList(shoppingList.id);

    return IBTodoList(
      title: shoppingList.title,
      subtitle: '$pendingCount pendente(s) de ${items.length} item(ns)',
      action: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          IconButton(
            tooltip: 'Adicionar item',
            onPressed: () => _openCreateShoppingItemSheet(shoppingList),
            icon: const IBIcon(
              IBIcon.addRounded,
              color: AppColors.primary700,
              size: 18,
            ),
          ),
          if (canConclude)
            TextButton(
              onPressed: () => controller.concludeList(shoppingList.id),
              child: IBText('Concluir', context: context).label.build(),
            ),
        ],
      ),
      items: items
          .map(
            (item) => IBTodoItemData(
              title: item.title,
              subtitle: _itemSubtitle(item),
              done: item.isDone,
            ),
          )
          .toList(),
      emptyLabel: 'Nenhum item nesta lista.',
      onToggle: (index, done) {
        controller.toggleItemAt(shoppingList.id, index, done);
      },
    );
  }

  String? _itemSubtitle(ShoppingItemOutput item) {
    final quantity = item.quantity?.trim();
    if (quantity == null || quantity.isEmpty) return null;
    return 'Adicional: $quantity';
  }

  Future<void> _openCreateShoppingListSheet() async {
    if (!mounted) return;

    await IBBottomSheet.show<void>(
      context: context,
      isFitWithContent: true,
      child: CreateShoppingListBottomSheet(
        loadingListenable: controller.loading,
        errorListenable: controller.error,
        onCreateList: controller.createShoppingList,
      ),
    );
  }

  Future<void> _openCreateShoppingItemSheet(ShoppingListOutput list) async {
    if (!mounted) return;

    await IBBottomSheet.show<void>(
      context: context,
      isFitWithContent: true,
      child: CreateShoppingItemBottomSheet(
        listTitle: list.title,
        loadingListenable: controller.loading,
        errorListenable: controller.error,
        onCreateItem: ({required title, quantity}) {
          return controller.createShoppingItem(
            listId: list.id,
            title: title,
            quantity: quantity,
          );
        },
      ),
    );
  }
}
